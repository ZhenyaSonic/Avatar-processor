# Тестовое задание: Обработка аватаров (Backend)

Этот проект представляет собой Django-приложение, которое при загрузке аватара пользователя автоматически сжимает его, обрезает до квадрата и сохраняет в S3-совместимое хранилище.

## Основные возможности

-   **Регистрация и аутентификация** пользователей через JWT.
-   **Просмотр профилей**: любой пользователь может видеть список и детали профилей.
-   **Редактирование профиля**: только владелец профиля может изменять свои данные и загружать аватар.
-   **Автоматическая обработка аватаров**:
    -   Сжатие без заметной потери качества.
    -   Обрезка до квадрата.
    -   Сохранение в S3-хранилище в персональную папку пользователя.

## Технологический стек и обоснование

-   **Backend:** `Django` — надежный и полнофункциональный фреймворк для быстрой разработки.
-   **Обработка изображений:** `Pillow` — стандартная и мощная библиотека для работы с изображениями в Python, идеально подходит для задач сжатия и обрезки.
-   **S3-хранилище:** `MinIO` — высокопроизводительное S3-совместимое хранилище, запущенное в Docker. Это позволяет полностью эмулировать S3 API локально, делая проект автономным и простым для развертывания.
-   **Интеграция с S3:** `django-storages` — стандартная библиотека для прозрачной замены файловой системы Django на облачное хранилище.
-   **Механизм обработки:** Переопределение метода `save()` модели — самый прямой и надежный способ гарантировать, что обработка происходит для каждого аватара перед его сохранением.
-   **Окружение:** `Docker` и `docker-compose` — для создания изолированного, предсказуемого и легко воспроизводимого окружения.

---

## Инструкции по установке и запуску

### Шаг 1: Подготовка

-   Убедитесь, что у вас установлены `Docker` и `docker-compose`.
-   Склонируйте репозиторий на ваш компьютер:
    ```bash
    git clone https://github.com/ZhenyaSonic/Avatar-processor.git
    cd avatar_processor
    ```
-   Создайте файл с переменными окружения на основе примера:
    ```bash
    cp .env.example .env
    ```
    *(При необходимости, измените `SECRET_KEY` в `.env`)*

### Шаг 2: Запуск проекта

Выполните команду в корневой папке проекта. Она соберет образы и запустит все сервисы (Django, Postgres, MinIO) в фоновом режиме.

```bash
docker-compose up --build -d
```

### Шаг 3: Первоначальная настройка MinIO (S3)

Для корректной работы проекта необходимо создать в MinIO "bucket" (корзину) и установить для него публичную политику доступа.

#### Часть 1: Создание бакета (веб-интерфейс)

1.  Откройте в браузере веб-консоль MinIO: **http://localhost:9001**
2.  Войдите, используя логин и пароль из вашего `.env` файла (по умолчанию: `minioadmin` / `minioadmin`).
3.  Нажмите на кнопку **"Create Bucket"** и создайте бакет с именем, указанным в `.env` (по умолчанию: **`avatars`**). На этом работа с веб-интерфейсом закончена.

#### Часть 2: Настройка политики доступа (командная строка)

Мы установим политику через командную строку — это самый надежный метод, который работает независимо от версии веб-интерфейса MinIO.

1.  **Войдите в командную строку контейнера `minio`:**
    ```bash
    docker-compose exec minio sh
    ```

2.  **Настройте клиент `mc` для работы с вашим локальным сервером:**
    ```sh
    mc alias set local http://localhost:9000 minioadmin minioadmin
    ```

3.  **Установите публичную политику доступа (`download`) для бакета:**
    ```sh
    mc anonymous set download local/avatars
    ```
    *Вы должны увидеть сообщение об успешной установке политики.*

4.  **Выйдите из контейнера:**
    ```bash
    exit
    ```

### Шаг 4: Настройка Django

Перед первым запуском необходимо подготовить базу данных и создать пользователя для входа в админ-панель.

1.  **Создайте и примените миграции:**
    Миграции создают в базе данных таблицы, соответствующие вашим Django-моделям.

    ```bash
    # Сначала создаем файл с инструкциями для приложения avatars
    docker-compose exec web python manage.py makemigrations avatars

    # Затем применяем все миграции для создания таблиц
    docker-compose exec web python manage.py migrate
    ```

2.  **Создайте суперпользователя:**
    Этот пользователь нужен для доступа к админ-панели Django.

    ```bash
    docker-compose exec web python manage.py createsuperuser
    ```
    *Следуйте инструкциям в терминале, чтобы задать имя пользователя, email и пароль.*

### Шаг 5: Проверка работы

1.  Перейдите в админ-панель Django: **http://localhost:8000/admin/**
2.  Войдите, используя данные созданного суперпользователя.
3.  Перейдите в раздел **"Profiles"** (`/admin/avatars/profile/`).
4.  Нажмите **"Add profile"**, введите имя и загрузите любое **неквадратное** изображение в поле **"Avatar"**.
5.  Сохраните профиль.
6.  Вернитесь в консоль MinIO (**http://localhost:9001**), зайдите в бакет `avatars`. Вы увидите, что загруженный файл был обработан (стал квадратным) и сохранен в S3.

---

## API Endpoints

**Базовый URL:** `http://localhost:8000/api/`

### Регистрация

-   **POST** `/api/register/`
    -   Создает нового пользователя.
    -   **Тело запроса (JSON):**
        ```json
        {
            "username": "newuser",
            "password": "strongpassword123",
            "email": "user@example.com"
        }
        ```

### Аутентификация (Получение токена)

-   **POST** `/api/token/`
    -   Получает пару JWT токенов (access и refresh).
    -   **Тело запроса (JSON):**
        ```json
        {
            "username": "newuser",
            "password": "strongpassword123"
        }
        ```
    -   **Ответ:**
        ```json
        {
            "refresh": "...",
            "access": "..."
        }
        ```
    -   `access` токен нужно передавать в заголовке `Authorization: Bearer <your_access_token>` для всех защищенных запросов.

### Профили

-   **GET** `/api/profiles/`
    -   Получение списка всех профилей. Доступно всем.

-   **GET** `/api/profiles/{id}/`
    -   Получение деталей конкретного профиля. Доступно всем.

-   **PATCH** `/api/profiles/{id}/`
    -   Частичное обновление своего профиля (например, только аватара).
    -   **Требуется аутентификация.**
    -   **Запрос (form-data):**
        ```
        name: "My New Nickname"
        avatar: (файл изображения)
        ```
    -   Пример с `curl`:
        ```bash
        curl -X PATCH http://localhost:8000/api/profiles/1/ \
        -H "Authorization: Bearer <your_access_token>" \
        -F "name=My New Nickname" \
        -F "avatar=@/path/to/your/image.jpg"
        ```

## Запуск автоматических тестов

Для проверки корректности всей логики (сжатие, обрезка, сохранение в S3) выполните команду:

```bash
docker-compose exec web python manage.py test
```

Тесты выполнят следующие проверки:
-   Файл после обработки успешно сохраняется в настроенном S3-хранилище.
-   Размеры изображения (ширина и высота) становятся одинаковыми.
-   Размер файла в байтах уменьшается по сравнению с оригиналом.

Успешное выполнение тестов завершится сообщением `OK`.
